---
title: 享元模式
author: DBAAZzz
date: 2025/11/30 23:50
categories:
  - 面试
tags:
  - 设计模式
  - 享元模式
---

## 享元模式

**享元模式**（Flyweight Pattern）主要用于减少创建对象的数量，以减少内存占用和提高性能。它通过共享技术有效地支持大量细粒度的对象。

核心思想：

- **区分内部状态和外部状态**：
  - **内部状态**：存储在对象内部，可以共享，不随环境改变（例如：汉字的字体、形状）。
  - **外部状态**：取决于环境，不可共享（例如：汉字在文章中的位置、颜色、大小）。
- **对象池**：维护一个池子，优先复用已有对象。

## 基本实现

假设我们要渲染 100 种不同型号的内衣，每种型号需要拍 50 张照片（不同颜色/背景）。如果为每张照片都创建一个模特对象，需要 5000 个对象。

但实际上，我们只需要 100 个不同型号的模特（或者更少，如果模特不分型号），然后让他们穿上不同的衣服拍照。

```javascript
// 享元对象：模特
class Model {
  constructor(sex) {
    this.sex = sex
  }

  takePhoto(underwear) {
    console.log(`sex=${this.sex} underwear=${underwear}`)
  }
}

// 只需要两个模特对象
const maleModel = new Model('male')
const femaleModel = new Model('female')

// 拍 50 张男装照片
for (let i = 1; i <= 50; i++) {
  maleModel.takePhoto(`男装${i}`) // 外部状态通过参数传入
}

// 拍 50 张女装照片
for (let i = 1; i <= 50; i++) {
  femaleModel.takePhoto(`女装${i}`)
}
```

只用了 2 个对象就完成了 100 次操作，而不是 100 个对象。

## 前端生态中的应用

### 1. 事件委托 (Event Delegation)

这是前端最经典的享元模式应用。

**不使用享元**：给列表中的每个 `li` 绑定事件处理器。如果有 1000 个 `li`，就有 1000 个函数对象。

**使用享元**：给父容器 `ul` 绑定一个事件处理器。所有 `li` 共享这一个处理器。

```javascript
document.getElementById('list').addEventListener('click', function (e) {
  if (e.target.nodeName === 'LI') {
    console.log('Clicked:', e.target.innerText)
  }
})
```

### 2. 对象池 (Object Pool)

在游戏开发（如子弹射击）、WebGL 渲染或高频 DOM 操作中，频繁创建和销毁对象会导致 GC（垃圾回收）卡顿。

使用对象池来复用对象：

```javascript
const objectPool = []

function create() {
  if (objectPool.length > 0) {
    return objectPool.pop() // 复用
  }
  return new Bullet() // 创建
}

function recover(bullet) {
  // 重置状态
  bullet.x = 0
  bullet.y = 0
  objectPool.push(bullet) // 回收
}
```

### 3. React 的合成事件 (SyntheticEvent)

在 React 16 及之前，React 实现了事件池。`SyntheticEvent` 对象会被复用。当事件回调被调用后，该对象的属性会被清空，以便下次复用。

> 注意：React 17+ 为了改善开发者体验，移除了事件池优化，因为现代浏览器 JS 引擎性能提升，对象创建成本降低，而事件池带来的“异步访问事件对象需 `e.persist()`”的心智负担较重。但这仍然是一个经典的享元模式案例。

## 面试重点

**"什么时候使用享元模式？"**

- 程序中使用了大量的相似对象。
- 由于使用了大量对象，造成了很大的内存开销。
- 对象的大多数状态可以是外部状态。
- 剥离出外部状态后，可以用相对较少的共享对象取代大量对象。

**"单例模式和享元模式的区别？"**

- **单例模式**：系统中只有一个实例。
- **享元模式**：系统中有一组实例（对象池），可以被复用。
