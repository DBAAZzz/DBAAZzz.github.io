---
title: Babel æ’ä»¶å¼€å‘ä¸åŸç†
author: DBAAZzz
date: 2025/12/28 21:47
categories:
  - é¢è¯•
tags:
  - babel
  - å·¥ç¨‹åŒ–
---

## 1. æ ¸å¿ƒæ¦‚å¿µ

Babel æ’ä»¶æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª**å‡½æ•°**ï¼Œå®ƒè¿”å›ä¸€ä¸ªåŒ…å« `visitor` å±æ€§çš„å¯¹è±¡ã€‚

Babel åœ¨å¤„ç†ä»£ç æ—¶ï¼ˆParse -> Transform -> Generateï¼‰ï¼Œæ’ä»¶ä¸»è¦ä»‹å…¥ **Transformï¼ˆè½¬æ¢ï¼‰** é˜¶æ®µã€‚

Babel ä½¿ç”¨ **è®¿é—®è€…æ¨¡å¼ï¼ˆVisitor Patternï¼‰** æ¥éå† ASTï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰ã€‚å½“éå†åˆ°ç‰¹å®šç±»å‹çš„èŠ‚ç‚¹æ—¶ï¼Œä¼šè°ƒç”¨æ’ä»¶ä¸­å®šä¹‰çš„æ–¹æ³•ã€‚

## 2. æ’ä»¶çš„åŸºæœ¬ç»“æ„

ä¸€ä¸ªæ ‡å‡†çš„ Babel æ’ä»¶ç»“æ„å¦‚ä¸‹ï¼š

```javascript
module.exports = function(api) {
  // api åŒ…å«äº† types, template, traverse, version ç­‰
  const { types: t } = api;

  return {
    name: "my-plugin", // æ’ä»¶åç§°ï¼ˆå¯é€‰ï¼‰
    // è®¿é—®è€…å¯¹è±¡
    visitor: {
      // åŒ¹é… Identifier èŠ‚ç‚¹
      Identifier(path, state) {
        // é€»è¾‘å¤„ç†
      },
      // ä¹Ÿå¯ä»¥æŒ‡å®š enter å’Œ exit æ—¶æœº
      CallExpression: {
        enter(path, state) { ... },
        exit(path, state) { ... }
      }
    }
  };
};
```

## 3. Pathï¼ˆè·¯å¾„ï¼‰ vs Nodeï¼ˆèŠ‚ç‚¹ï¼‰

è¿™æ˜¯é¢è¯•ä¸­é«˜é¢‘è€ƒå¯Ÿç‚¹ï¼š

- **Node (AST Node)**: çœŸå®çš„æ•°æ®ç»“æ„ï¼ŒåŒ…å«ä»£ç ä¿¡æ¯ï¼ˆå¦‚ `type`, `name`, `value`ï¼‰ã€‚å®ƒæ˜¯é™æ€çš„ã€‚
- **Path (NodePath)**: åŒ…è£…äº† Node çš„å¯¹è±¡ï¼Œæä¾›äº†**æ“ä½œèŠ‚ç‚¹çš„æ–¹æ³•**ï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰å’Œ**ä¸Šä¸‹æ–‡ä¿¡æ¯**ï¼ˆçˆ¶èŠ‚ç‚¹ã€ä½œç”¨åŸŸ scopeï¼‰ã€‚å®ƒæ˜¯**å“åº”å¼**çš„ã€‚

**å¸¸ç”¨ Path APIï¼š**

| API                      | æè¿°                                       |
| :----------------------- | :----------------------------------------- |
| `path.node`              | è·å–å½“å‰ AST èŠ‚ç‚¹                          |
| `path.parent`            | è·å–çˆ¶ AST èŠ‚ç‚¹                            |
| `path.get('key')`        | è·å–å­å±æ€§çš„ pathï¼ˆå¦‚ `path.get('body')`ï¼‰ |
| `path.replaceWith(node)` | æ›¿æ¢å½“å‰èŠ‚ç‚¹                               |
| `path.remove()`          | åˆ é™¤å½“å‰èŠ‚ç‚¹                               |
| `path.skip()`            | è·³è¿‡å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹éå†                   |
| `path.stop()`            | åœæ­¢æ•´ä¸ªéå†                               |
| `path.findParent(cb)`    | å‘ä¸ŠæŸ¥æ‰¾çˆ¶èŠ‚ç‚¹                             |

## 4. æ’ä»¶æ‰§è¡Œé¡ºåº

Babel çš„æ’ä»¶å’Œ Presetï¼ˆé¢„è®¾ï¼‰æ‰§è¡Œé¡ºåºæœ‰ä¸¥æ ¼è§„å®šï¼š

1.  **Plugins åœ¨ Presets ä¹‹å‰è¿è¡Œ**ã€‚
2.  **Plugins é¡ºåº**ï¼šä»å‰å‘åï¼ˆæ•°ç»„é¡ºåºï¼‰ã€‚
3.  **Presets é¡ºåº**ï¼š**ä»åå‘å‰**ï¼ˆé¢ å€’ï¼‰ã€‚
    - ä¾‹å¦‚ `presets: ['@babel/preset-env', '@babel/preset-react']`ï¼Œä¼šå…ˆæ‰§è¡Œ `preset-react`ï¼Œå†æ‰§è¡Œ `preset-env`ã€‚
    - **è®¾è®¡åŸå› **ï¼šè®©è¯­æ³•ç³–ï¼ˆå¦‚ JSXï¼‰å…ˆè¢«è½¬æ¢æˆæ ‡å‡† JSï¼Œç„¶å `preset-env` å†è¿›è¡Œ ES6+ çš„é™çº§å¤„ç†ã€‚è¿™æ ·å¯ä»¥é¿å…è¯­æ³•å†²çªï¼Œç¡®ä¿è½¬æ¢çš„æ­£ç¡®æ€§ã€‚

## 5. å®æˆ˜ï¼šæ‰‹å†™ç§»é™¤ console.log çš„æ’ä»¶

è¿™æ˜¯ä¸€é“ç»å…¸çš„é¢è¯•æ‰‹å†™é¢˜ã€‚

**éœ€æ±‚**ï¼šç§»é™¤ä»£ç ä¸­æ‰€æœ‰çš„ `console.log`ï¼Œä½†ä¿ç•™ `console.error`ã€‚

**æ€è·¯**ï¼š

1.  ç›‘å¬ `CallExpression`ï¼ˆå‡½æ•°è°ƒç”¨è¡¨è¾¾å¼ï¼‰ã€‚
2.  åˆ¤æ–­è¢«è°ƒç”¨è€…ï¼ˆcalleeï¼‰æ˜¯å¦æ˜¯æˆå‘˜è¡¨è¾¾å¼ï¼ˆMemberExpressionï¼‰ã€‚
3.  åˆ¤æ–­å¯¹è±¡æ˜¯å¦æ˜¯ `console`ï¼Œå±æ€§æ˜¯å¦æ˜¯ `log`ã€‚
4.  å¦‚æœå‘½ä¸­ï¼Œè°ƒç”¨ `path.remove()`ã€‚

```javascript
module.exports = function ({ types: t }) {
  return {
    visitor: {
      CallExpression(path) {
        const { callee } = path.node;

        // åˆ¤æ–­æ˜¯å¦æ˜¯æˆå‘˜è¡¨è¾¾å¼å½¢å¼ï¼Œå¦‚ foo.bar()
        if (t.isMemberExpression(callee)) {
          const { object, property } = callee;

          // åˆ¤æ–­ object æ˜¯ 'console' ä¸” property æ˜¯ 'log'
          if (
            t.isIdentifier(object, { name: "console" }) &&
            t.isIdentifier(property, { name: "log" })
          ) {
            path.remove();
          }
        }
      },
    },
  };
};
```

## 6. Scopeï¼ˆä½œç”¨åŸŸï¼‰

åœ¨åšå˜é‡æ··æ·†æˆ–é‡å‘½åæ—¶ï¼Œå¿…é¡»å¤„ç†ä½œç”¨åŸŸï¼Œé˜²æ­¢å‘½åå†²çªã€‚

- `path.scope.hasBinding('x')`: æ£€æŸ¥ä½œç”¨åŸŸå†…æ˜¯å¦å·²æœ‰å˜é‡ xã€‚
- `path.scope.generateUidIdentifier('uid')`: ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†ç¬¦ï¼ˆå˜é‡åï¼‰ï¼Œé¿å…å†²çªã€‚
- `path.scope.rename('a', 'b')`: å°†ä½œç”¨åŸŸå†…çš„ a é‡å‘½åä¸º bã€‚

## 7. å¸¸è§é¢è¯•é¢˜æ€»ç»“

1.  **Babel çš„ç¼–è¯‘æµç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ**
    - Parseï¼ˆè§£æï¼šä»£ç  -> ASTï¼‰ -> Transformï¼ˆè½¬æ¢ï¼šAST -> ASTï¼‰ -> Generateï¼ˆç”Ÿæˆï¼šAST -> ä»£ç ï¼‰ã€‚
2.  **`babel-loader` å’Œ `babel-plugin` çš„åŒºåˆ«ï¼Ÿ**
    - `babel-loader` æ˜¯ Webpack çš„åŠ è½½å™¨ï¼Œå®ƒæ˜¯ Webpack å’Œ Babel çš„æ¡¥æ¢ã€‚
    - `babel-plugin` æ˜¯ Babel çš„è½¬æ¢é€»è¾‘å•å…ƒï¼ŒçœŸæ­£ä¿®æ”¹ä»£ç çš„åœ°æ–¹ã€‚
3.  **Visitor æ¨¡å¼çš„å¥½å¤„æ˜¯ä»€ä¹ˆï¼Ÿ**
    - è§£è€¦äº†éå†é€»è¾‘å’Œæ“ä½œé€»è¾‘ã€‚æ’ä»¶åªéœ€è¦å…³å¿ƒâ€œé‡åˆ°ä»€ä¹ˆèŠ‚ç‚¹åšä»€ä¹ˆâ€ï¼Œè€Œä¸éœ€è¦å…³å¿ƒâ€œæ€ä¹ˆæ‰¾åˆ°è¿™ä¸ªèŠ‚ç‚¹â€ã€‚

## 8. è¿›é˜¶ï¼šæ’ä»¶é…ç½®å¯¹è±¡è¯¦è§£

åœ¨ç¼–å†™ Babel æ’ä»¶æ—¶ï¼Œå¯¼å‡ºçš„å‡½æ•°ï¼ˆ`module.exports = function(api) { ... }`ï¼‰éœ€è¦è¿”å›ä¸€ä¸ª**é…ç½®å¯¹è±¡**ã€‚

é™¤äº†æœ€æ ¸å¿ƒçš„ `visitor`ï¼Œè¿™ä¸ªå¯¹è±¡è¿˜åŒ…å«ç”Ÿå‘½å‘¨æœŸé’©å­ã€å…ƒæ•°æ®é…ç½®ç­‰å±æ€§ã€‚

ä»¥ä¸‹æ˜¯å®Œæ•´çš„å±æ€§æ¸…å•åŠå…¶ä½œç”¨ï¼š

### 1. æ ¸å¿ƒå±æ€§

| å±æ€§å        | ç±»å‹     | ä½œç”¨                                                                                                    | é‡è¦æ€§     |
| ------------- | -------- | ------------------------------------------------------------------------------------------------------- | ---------- |
| **`visitor`** | `Object` | **æ ¸å¿ƒé€»è¾‘**ã€‚å®šä¹‰ AST éå†æ—¶çš„å›è°ƒå‡½æ•°ï¼ˆå¦‚ `Identifier() {}`ï¼‰ã€‚è¿™æ˜¯æ’ä»¶å·¥ä½œçš„æ ¹æ®åœ°ã€‚                 | â­â­â­â­â­ |
| **`name`**    | `String` | **æ’ä»¶åç§°**ã€‚ç”¨äºæŠ¥é”™æ—¶çš„å †æ ˆè¿½è¸ªã€‚å¦‚æœä¸å†™ï¼ŒBabel æŠ¥é”™æ—¶å¯èƒ½åªä¼šæ˜¾ç¤º "unknown plugin"ï¼Œè°ƒè¯•ä¼šå¾ˆç—›è‹¦ã€‚ | â­â­â­     |

### 2. ç”Ÿå‘½å‘¨æœŸ (å¤„ç†å•ä¸ªæ–‡ä»¶æ—¶)

è¿™ä¸¤ä¸ªé’©å­ç”¨äºåœ¨å¤„ç†**æ¯ä¸€ä¸ªæ–‡ä»¶**çš„å‰åæ‰§è¡Œé€»è¾‘ï¼Œé€šå¸¸ç”¨äº**åˆå§‹åŒ–çŠ¶æ€**æˆ–**æ”¶å°¾åˆ†æ**ã€‚

| å±æ€§å     | ç±»å‹              | ä½œç”¨                                                                                                     |
| ---------- | ----------------- | -------------------------------------------------------------------------------------------------------- |
| **`pre`**  | `Function(state)` | **éå†å‰è§¦å‘**ã€‚ç”¨äºåˆå§‹åŒ–æŸäº›å˜é‡ã€‚æ¯”å¦‚ä½ æƒ³ç»Ÿè®¡ä¸€ä¸ªæ–‡ä»¶é‡Œæœ‰å¤šå°‘ä¸ª console.logï¼Œå¯ä»¥åœ¨è¿™é‡ŒæŠŠè®¡æ•°å™¨ç½®é›¶ã€‚ |
| **`post`** | `Function(state)` | **éå†åè§¦å‘**ã€‚æ–‡ä»¶ AST éå†å®Œæˆåæ‰§è¡Œã€‚ç”¨äºæ¸…ç†å·¥ä½œã€ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Šæˆ–æ ¡éªŒç»“æœã€‚                          |

> **ğŸ’¡ å…³é”®ç‚¹ï¼šState å…±äº«**
> åœ¨ `pre`ã€`post` ä»¥åŠ `visitor` çš„æ–¹æ³•ä¸­ï¼Œ`this` æŒ‡å‘åŒä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡ï¼ˆ`PluginPass`ï¼‰ã€‚è¿™æ˜¯åœ¨ä¸åŒ visitor æ–¹æ³•ä¹‹é—´å…±äº«æ•°æ®çš„æ ‡å‡†æ–¹å¼ã€‚

### 3. è§£æä¸è¯­æ³•æ‰©å±• (é«˜çº§)

| å±æ€§å                  | ç±»å‹                         | ä½œç”¨                                                                                                                                                                    |
| ----------------------- | ---------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **`inherits`**          | `Function`                   | **ç»§æ‰¿è¯­æ³•æ”¯æŒ**ã€‚å¦‚æœä½ çš„æ’ä»¶å¤„ç†æŸç§ç‰¹æ®Šè¯­æ³•ï¼ˆå¦‚ JSXï¼‰ï¼Œå¯ä»¥è®©å®ƒç»§æ‰¿ `@babel/plugin-syntax-jsx`ï¼Œè¿™æ · Babel Parser å°±èƒ½è¯†åˆ«è¯¥è¯­æ³•ï¼Œè€Œä¸éœ€è¦ç”¨æˆ·æ‰‹åŠ¨é…ç½® syntax æ’ä»¶ã€‚ |
| **`manipulateOptions`** | `Function(opts, parserOpts)` | **ä¿®æ”¹ Parser é…ç½®**ã€‚åœ¨è§£æ AST ä¹‹å‰æ‰§è¡Œï¼Œå…è®¸ä½ ç›´æ¥ä¿®æ”¹ parser çš„ç™½åå•ï¼ˆå¦‚å¼€å¯æŸä¸ª parser æ’ä»¶ï¼‰ã€‚                                                                   |

---

### ä»£ç ç»“æ„ç¤ºä¾‹

è¿™æ˜¯ä¸€ä¸ªåŒ…å«æ‰€æœ‰å¸¸ç”¨å±æ€§çš„æ’ä»¶éª¨æ¶ï¼š

```javascript
module.exports = function (api) {
  return {
    // 1. æ¨èå¿…å¡«ï¼šæ–¹ä¾¿è°ƒè¯•
    name: "my-custom-plugin",

    // 2. å¯é€‰ï¼šç»§æ‰¿è¯­æ³•ï¼ˆä¾‹å¦‚è®© parser èƒ½è¯»æ‡‚ JSXï¼‰
    inherits: require("@babel/plugin-syntax-jsx").default,

    // 3. å¯é€‰ï¼šéå†å‰åˆå§‹åŒ–çŠ¶æ€
    pre(state) {
      // this æŒ‡å‘ PluginPass å¯¹è±¡
      this.cache = new Map();
      console.log("å¼€å§‹å¤„ç†æ–‡ä»¶:", this.filename);
    },

    // 4. æ ¸å¿ƒï¼šéå†é€»è¾‘
    visitor: {
      Identifier(path) {
        // åœ¨ visitor ä¸­é€šè¿‡ this è®¿é—® pre ä¸­å®šä¹‰çš„æ•°æ®
        if (this.cache.has(path.node.name)) {
          // ...
        }
      },
    },

    // 5. å¯é€‰ï¼šéå†åæ”¶å°¾
    post(state) {
      console.log("æ–‡ä»¶å¤„ç†ç»“æŸ");
      this.cache.clear(); // æ¸…ç†å†…å­˜
    },

    // 6. é«˜çº§ï¼šç›´æ¥ä¿®æ”¹ parser é€‰é¡¹
    manipulateOptions(opts, parserOpts) {
      // æ¯”å¦‚å¼ºåˆ¶å¼€å¯ classProperties è¯­æ³•æ”¯æŒ
      parserOpts.plugins.push("classProperties");
    },
  };
};
```

### æ€»ç»“ï¼šæ—¥å¸¸å¼€å‘ç”¨å“ªäº›ï¼Ÿ

1. **90% çš„æƒ…å†µ**ï¼šåªéœ€è¦ `visitor` å’Œ `name`ã€‚
2. **éœ€è¦è·¨èŠ‚ç‚¹å…±äº«æ•°æ®æ—¶**ï¼šåŠ ä¸Š `pre` å’Œ `post`ï¼ˆåˆ©ç”¨ `this`ï¼‰ã€‚
3. **å†™è¯­æ³•è½¬æ¢æ’ä»¶æ—¶**ï¼šå¯èƒ½ä¼šç”¨åˆ° `inherits`ã€‚
4. **`manipulateOptions`**ï¼šæå°‘ä½¿ç”¨ï¼Œé€šå¸¸ç”±å®˜æ–¹ syntax æ’ä»¶å¤„ç†ã€‚
